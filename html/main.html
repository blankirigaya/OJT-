<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Issue Reporting System</title>
    <link rel="stylesheet" href="../css/styles.css">
</head>

<body>

<div class="user-info" id="userInfo" style="display: none;">
    <span class="user-email" id="userEmail"></span>
    <button class="logout-btn" onclick="handleLogout()">Logout</button>
</div>

<div class="main-container">
    <!-- Team Panel -->
    <div class="team-panel">
        <h2>üë• My Team</h2>
        <div id="teamContent"></div>
    </div>

    <!-- Form Container -->
    <div class="form-container">
        <h1>Report an Issue</h1>
        <p>Help us improve by reporting bugs or requesting features</p>

        <form id="issueForm">
            <div class="form-group">
                <label>Issue Title *</label>
                <input type="text" id="title" required placeholder="Brief description">
            </div>

            <div class="form-group">
                <label>Your Email *</label>
                <input type="email" id="email" required placeholder="you@email.com" readonly>
            </div>

            <div class="form-group">
                <label>Priority *</label>
                <select id="priority" required>
                    <option value="">Select priority</option>
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                </select>
            </div>

            <div class="form-group">
                <label>Category *</label>
                <select id="category" required>
                    <option value="">Select category</option>
                    <option value="bug">Bug Report</option>
                    <option value="feature">Feature Request</option>
                </select>
            </div>

            <div class="form-group">
                <label>Description *</label>
                <textarea id="description" required placeholder="Describe the issue in detail..."></textarea>
            </div>

            <button type="submit" class="submit-btn">Submit Issue</button>
        </form>
    </div>

    <!-- Issues Sidebar -->
    <div class="issues-sidebar">
        <h2>üìã Recent Issues</h2>
        <div id="issuesList"></div>
    </div>
</div>

<!-- Issue Details Modal -->
<div class="issue-details-modal" id="issueDetailsModal">
    <div class="issue-details-content">
        <button class="close-details-btn" onclick="closeIssueDetails()">Close</button>
        <div id="issueDetailsContent"></div>
    </div>
</div>

<!-- Create Team Modal -->
<div class="modal" id="createTeamModal">
    <div class="modal-content">
        <h2>Create a Team</h2>
        <input type="text" id="teamNameInput" placeholder="Team name (e.g., Engineering Team)" required>
        <button onclick="createTeam()">Create Team</button>
        <button class="close-modal-btn" onclick="closeCreateTeamModal()">Cancel</button>
    </div>
</div>

<script type="module">// Replace the <script type="module"> in main.html with this updated version

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref, push, set, onValue, query, orderByChild, get, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

const firebaseConfig = {
    apiKey: "AIzaSyBeqThBgikkUrn_HytZHFUxPs19kJsFHXo",
    authDomain: "issuelogger-522de.firebaseapp.com",
    databaseURL: "https://issuelogger-522de-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "issuelogger-522de",
    storageBucket: "issuelogger-522de.firebasestorage.app",
    messagingSenderId: "964094432254",
    appId: "1:964094432254:web:c51ccade6af6bef5a0a6af",
    measurementId: "G-H92P42RJFD"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const database = getDatabase(app);

let currentUser = null;
let allIssues = [];
let currentTeam = null;
let issuesListener = null;

console.log("üî• Firebase initialized");

async function storeUserEmail(userId, email) {
    try {
        await set(ref(database, `users/${userId}/email`), email);
        const emailKey = email.replace(/\./g, '_').replace(/@/g, '_at_');
        await set(ref(database, `userEmails/${emailKey}`), userId);
        console.log("‚úÖ User email stored:", email);
    } catch (error) {
        console.error("‚ùå Error storing user email:", error);
    }
}

async function checkPendingInvites(userEmail) {
    const inviteKey = userEmail.replace(/\./g, '_').replace(/@/g, '_at_');
    const inviteRef = ref(database, `invites/${inviteKey}`);
    
    try {
        const snapshot = await get(inviteRef);
        if (snapshot.exists()) {
            const invite = snapshot.val();
            console.log("üìß Found pending invite:", invite);
            
            // Add user to team
            await set(ref(database, `teams/${invite.teamId}/members/${currentUser.uid}`), {
                email: userEmail,
                joinedAt: Date.now()
            });
            
            // Set user's team
            await set(ref(database, `users/${currentUser.uid}/teamId`), invite.teamId);
            
            // Delete the invite after processing
            await set(inviteRef, null);
            
            console.log("‚úÖ User automatically added to team:", invite.teamName);
            showSuccessMessage(`üéâ You've been automatically added to ${invite.teamName}!`);
        } else {
            console.log("üî≠ No pending invites");
        }
    } catch (error) {
        console.error("‚ùå Error checking invites:", error);
    }
}

onAuthStateChanged(auth, async (user) => {
    if (user) {
        currentUser = user;
        console.log("üë§ User authenticated:", user.email, "UID:", user.uid);
        
        document.getElementById('userInfo').style.display = 'flex';
        // Display user's display name or email if name not available
        const displayName = user.displayName || user.email.split('@')[0];
        document.getElementById('userEmail').textContent = displayName;
        document.getElementById('email').value = user.email;
        
        await storeUserEmail(user.uid, user.email);
        await checkPendingInvites(user.email);
        loadUserTeam(user.uid);
    } else {
        console.log("‚ùå No user authenticated");
        window.location.href = 'index.html';
    }
});

let teamListener = null;

function loadUserTeam(userId) {
    console.log("üìç Loading team for user:", userId);
    const userTeamRef = ref(database, `users/${userId}/teamId`);
    
    onValue(userTeamRef, async (snapshot) => {
        const teamId = snapshot.val();
        console.log("üìä Team ID from database:", teamId);
        
        // Remove previous team listener
        if (teamListener) {
            teamListener();
        }
        
        if (!teamId) {
            console.log("‚ö†Ô∏è User has no team");
            renderNoTeam();
            allIssues = [];
            renderIssues([]);
            currentTeam = null;
            return;
        }
        
        const teamRef = ref(database, `teams/${teamId}`);
        teamListener = onValue(teamRef, (teamSnapshot) => {
            if (teamSnapshot.exists()) {
                currentTeam = { id: teamId, ...teamSnapshot.val() };
                console.log("‚úÖ Team loaded:", currentTeam.name, "Members:", Object.keys(currentTeam.members || {}).length);
                renderTeam(currentTeam, userId);
                loadTeamIssues(teamId);
            } else {
                console.log("‚ùå Team not found in database");
                renderNoTeam();
                currentTeam = null;
            }
        }, (error) => {
            console.error("‚ùå Error loading team:", error);
        });
    }, (error) => {
        console.error("‚ùå Error loading user team:", error);
    });
}

function loadTeamIssues(teamId) {
    console.log("üìç Loading issues for team:", teamId);
    const issuesRef = ref(database, `teamIssues/${teamId}`);
    const issuesQuery = query(issuesRef, orderByChild('timestamp'));
    
    // Remove previous listener if it exists
    if (issuesListener) {
        issuesListener();
    }
    
    // Set up real-time listener for all team issues
    issuesListener = onValue(issuesQuery, (snapshot) => {
        console.log("üìä Issues snapshot received");
        const issuesContainer = document.getElementById("issuesList");
        
        if (!snapshot.exists()) {
            console.log("üî≠ No issues found for this team");
            issuesContainer.innerHTML = `<p class="empty-state">No issues reported yet</p>`;
            allIssues = [];
            return;
        }
        
        allIssues = [];
        snapshot.forEach((childSnapshot) => {
            const issue = childSnapshot.val();
            issue.id = childSnapshot.key;
            allIssues.push(issue);
            console.log("üìù Issue loaded:", issue.title);
        });
        
        allIssues.reverse();
        console.log(`‚úÖ Total issues loaded: ${allIssues.length}`);
        renderIssues(allIssues);
    }, (error) => {
        console.error("‚ùå Error loading team issues:", error);
        console.error("Error code:", error.code);
        console.error("Error message:", error.message);
        
        if (error.code === 'PERMISSION_DENIED') {
            alert("‚ö†Ô∏è Permission denied! Please check your Firebase Database Rules.");
            document.getElementById("issuesList").innerHTML = 
                `<p class="empty-state" style="color: red;">Permission denied. Check database rules.</p>`;
        }
    });
}

function renderTeam(team, currentUserId) {
    const teamContent = document.getElementById('teamContent');
    const isOwner = team.ownerId === currentUserId;
    const userRole = isOwner ? 'Owner' : 'Member';
    
    let membersHtml = '';
    if (team.members) {
        membersHtml = Object.entries(team.members).map(([uid, memberData]) => {
            const initials = memberData.email.substring(0, 2).toUpperCase();
            const isCurrentUser = uid === currentUserId;
            return `
                <div class="member-item">
                    <div class="member-avatar">${initials}</div>
                    <div class="member-info">
                        <div class="member-name">${memberData.email.split('@')[0]}${isCurrentUser ? ' (You)' : ''}</div>
                        <div class="member-email">${memberData.email}</div>
                    </div>
                    ${isOwner && !isCurrentUser ? `
                        <button class="remove-member-btn" onclick="removeMember('${uid}', '${escapeHtml(memberData.email)}')">‚úï</button>
                    ` : ''}
                </div>
            `;
        }).join('');
    }
    
    teamContent.innerHTML = `
        <div class="team-info">
            <div class="team-name">${escapeHtml(team.name)}</div>
            <div class="team-role">${userRole}</div>
        </div>
        <div class="team-members">
            <h3>MEMBERS (${team.members ? Object.keys(team.members).length : 0})</h3>
            ${membersHtml}
        </div>
        ${isOwner ? `
            <div class="invite-section">
                <h3>Invite Member</h3>
                <input type="email" class="invite-input" id="inviteEmail" placeholder="Enter email address">
                <button class="invite-btn" onclick="inviteMember()">Send Invite</button>
            </div>
        ` : ''}
        <button class="leave-team-btn" onclick="leaveTeam()">Leave Team</button>
    `;
}

function renderNoTeam() {
    const teamContent = document.getElementById('teamContent');
    teamContent.innerHTML = `
        <div class="no-team">
            <p>You're not part of any team yet.</p>
        </div>
        <button class="create-team-btn" onclick="openCreateTeamModal()">Create Team</button>
    `;
}

window.openCreateTeamModal = function() {
    document.getElementById('createTeamModal').style.display = 'flex';
}

window.closeCreateTeamModal = function() {
    document.getElementById('createTeamModal').style.display = 'none';
    document.getElementById('teamNameInput').value = '';
}

window.createTeam = async function() {
    const teamName = document.getElementById('teamNameInput').value.trim();
    if (!teamName) {
        alert('Please enter a team name');
        return;
    }
    if (!currentUser) return;
    
    console.log("üó≥Ô∏è Creating team:", teamName);
    
    try {
        const teamsRef = ref(database, 'teams');
        const newTeamRef = push(teamsRef);
        const teamId = newTeamRef.key;
        
        console.log("üìù Team ID:", teamId);
        
        await set(newTeamRef, {
            name: teamName,
            ownerId: currentUser.uid,
            createdAt: Date.now(),
            members: {
                [currentUser.uid]: {
                    email: currentUser.email,
                    joinedAt: Date.now()
                }
            }
        });
        
        await set(ref(database, `users/${currentUser.uid}/teamId`), teamId);
        
        console.log("‚úÖ Team created successfully");
        showSuccessMessage('Team created successfully!');
        closeCreateTeamModal();
    } catch (error) {
        console.error('‚ùå Error creating team:', error);
        alert('Failed to create team. Please try again.');
    }
}

window.removeMember = async function(memberId, memberEmail) {
    if (!currentTeam) return;
    
    const confirmed = confirm(`Are you sure you want to remove ${memberEmail} from the team?`);
    if (!confirmed) return;
    
    console.log("üóëÔ∏è Removing member:", memberId, memberEmail);
    
    try {
        // Remove from team members
        await set(ref(database, `teams/${currentTeam.id}/members/${memberId}`), null);
        
        // Clear user's team assignment
        await set(ref(database, `users/${memberId}/teamId`), null);
        
        console.log("‚úÖ Member removed successfully");
        showSuccessMessage(`${memberEmail} has been removed from the team`);
    } catch (error) {
        console.error('‚ùå Error removing member:', error);
        alert('Failed to remove member: ' + error.message);
    }
}

window.leaveTeam = async function() {
    if (!currentTeam || !currentUser) return;
    
    const confirmed = confirm(`Are you sure you want to leave ${currentTeam.name}? You'll no longer see this team's issues.`);
    if (!confirmed) return;
    
    console.log("üëã Leaving team:", currentTeam.name);
    
    try {
        // Remove from team members
        await set(ref(database, `teams/${currentTeam.id}/members/${currentUser.uid}`), null);
        
        // Clear user's team assignment
        await set(ref(database, `users/${currentUser.uid}/teamId`), null);
        
        console.log("‚úÖ Left team successfully");
        showSuccessMessage(`You've left ${currentTeam.name}`);
        
        // Reset UI
        currentTeam = null;
        allIssues = [];
        renderNoTeam();
        renderIssues([]);
    } catch (error) {
        console.error('‚ùå Error leaving team:', error);
        alert('Failed to leave team: ' + error.message);
    }
}

window.inviteMember = async function() {
    const email = document.getElementById('inviteEmail').value.trim();
    if (!email) {
        alert('Please enter an email address');
        return;
    }
    if (!currentTeam) return;
    
    console.log("üìß Inviting member:", email);
    
    try {
        const emailKey = email.replace(/\./g, '_').replace(/@/g, '_at_');
        const emailLookupRef = ref(database, `userEmails/${emailKey}`);
        const emailSnapshot = await get(emailLookupRef);
        
        if (emailSnapshot.exists()) {
            // User already exists, add them directly
            const foundUserId = emailSnapshot.val();
            console.log("‚úÖ User found:", foundUserId);
            
            await set(ref(database, `teams/${currentTeam.id}/members/${foundUserId}`), {
                email: email,
                joinedAt: Date.now()
            });
            await set(ref(database, `users/${foundUserId}/teamId`), currentTeam.id);
            showSuccessMessage('Member added to team!');
        } else {
            // User doesn't exist yet, create pending invite
            console.log("üìÆ User not found, creating invite");
            const inviteKey = email.replace(/\./g, '_').replace(/@/g, '_at_');
            const invitesRef = ref(database, `invites/${inviteKey}`);
            await set(invitesRef, {
                teamId: currentTeam.id,
                teamName: currentTeam.name,
                invitedBy: currentUser.email,
                invitedAt: Date.now()
            });
            showSuccessMessage('Invitation sent! They will be automatically added when they sign up.');
        }
        
        document.getElementById('inviteEmail').value = '';
    } catch (error) {
        console.error('‚ùå Error inviting member:', error);
        alert('Failed to invite member: ' + error.message);
    }
}

function renderIssues(issues){
    const container = document.getElementById("issuesList");
    if(issues.length === 0){
        container.innerHTML = `<p class="empty-state">No issues reported yet</p>`;
        return;
    }
    container.innerHTML = issues.map(issue => {
        const timeAgo = getTimeAgo(issue.timestamp);
        const priorityClass = issue.priority.toLowerCase();
        const submitterName = issue.submitterEmail ? issue.submitterEmail.split('@')[0] : 'Unknown';
        return `
            <div class="issue-card" data-id="${issue.id}" onclick="showIssueDetails('${issue.id}')">
                <div class="issue-title">${escapeHtml(issue.title)}</div>
                <div class="issue-meta">
                    <span class="priority-badge ${priorityClass}">${issue.priority}</span>
                    <span>‚Ä¢</span>
                    <span>${issue.category === 'bug' ? 'üêõ Bug' : '‚ú® Feature'}</span>
                    <span>‚Ä¢</span>
                    <span>${submitterName}</span>
                    <span>‚Ä¢</span>
                    <span>${timeAgo}</span>
                </div>
            </div>
        `;
    }).join("");
}

window.showIssueDetails = function(issueId) {
    const issue = allIssues.find(i => i.id === issueId);
    if (!issue) return;
    const modal = document.getElementById('issueDetailsModal');
    const content = document.getElementById('issueDetailsContent');
    const priorityClass = issue.priority.toLowerCase();
    const date = new Date(issue.timestamp);
    content.innerHTML = `
        <h2>${escapeHtml(issue.title)}</h2>
        <div class="detail-row">
            <div class="detail-label">Submitted By</div>
            <div class="detail-value">${escapeHtml(issue.submitterEmail || issue.email)}</div>
        </div>
        <div class="detail-row">
            <div class="detail-label">Submitted</div>
            <div class="detail-value">${date.toLocaleString()}</div>
        </div>
        <div class="detail-row">
            <div class="detail-label">Priority</div>
            <div class="detail-value"><span class="priority-badge ${priorityClass}">${issue.priority}</span></div>
        </div>
        <div class="detail-row">
            <div class="detail-label">Status</div>
            <div class="detail-value">${issue.status || 'Open'}</div>
        </div>
        <div class="detail-row">
            <div class="detail-label">Description</div>
            <div class="detail-value" style="white-space: pre-wrap;">${escapeHtml(issue.description)}</div>
        </div>
    `;
    modal.style.display = 'flex';
    document.querySelectorAll('.issue-card').forEach(card => {
        card.classList.remove('active');
    });
    document.querySelector(`[data-id="${issueId}"]`)?.classList.add('active');
}

window.closeIssueDetails = function() {
    document.getElementById('issueDetailsModal').style.display = 'none';
    document.querySelectorAll('.issue-card').forEach(card => {
        card.classList.remove('active');
    });
}

document.getElementById('issueDetailsModal')?.addEventListener('click', function(e) {
    if (e.target === this) closeIssueDetails();
});

document.getElementById('createTeamModal')?.addEventListener('click', function(e) {
    if (e.target === this) closeCreateTeamModal();
});

const issueForm = document.getElementById("issueForm");
issueForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    
    if (!currentUser) {
        alert("You must be logged in to submit an issue");
        return;
    }
    
    if (!currentTeam) {
        alert("You must be part of a team to submit issues");
        return;
    }
    
    const title = document.getElementById("title").value.trim();
    const email = document.getElementById("email").value.trim();
    const priority = document.getElementById("priority").value;
    const category = document.getElementById("category").value;
    const description = document.getElementById("description").value.trim();
    
    if (!title || !email || !priority || !category || !description) {
        alert("Please fill in all required fields");
        return;
    }
    
    const issue = {
        title: title,
        email: email,
        submitterEmail: currentUser.email,
        submitterId: currentUser.uid,
        priority: priority,
        category: category,
        description: description,
        timestamp: Date.now(),
        status: "open",
        teamId: currentTeam.id
    };
    
    console.log("üìù Submitting issue:", issue);
    
    try {
        const issuesRef = ref(database, `teamIssues/${currentTeam.id}`);
        const newIssueRef = push(issuesRef);
        
        console.log("üíæ Saving to:", `teamIssues/${currentTeam.id}/${newIssueRef.key}`);
        
        await set(newIssueRef, issue);
        
        console.log("‚úÖ Issue submitted successfully");
        showSuccessMessage("Issue submitted successfully!");
        
        issueForm.reset();
        document.getElementById("email").value = currentUser.email;
    } catch (error) {
        console.error("‚ùå Error submitting issue:", error);
        console.error("Error code:", error.code);
        console.error("Error message:", error.message);
        
        if (error.code === 'PERMISSION_DENIED') {
            alert("‚ö†Ô∏è Permission denied! Please check your Firebase Database Rules.");
        } else {
            alert("Failed to submit issue. Check console for details.");
        }
    }
});

function getTimeAgo(timestamp) {
    const now = Date.now();
    const diff = now - timestamp;
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    if (minutes < 1) return "Just now";
    if (minutes < 60) return `${minutes}m ago`;
    if (hours < 24) return `${hours}h ago`;
    if (days < 7) return `${days}d ago`;
    const date = new Date(timestamp);
    return date.toLocaleDateString();
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function showSuccessMessage(message) {
    const successDiv = document.createElement('div');
    successDiv.className = 'success-toast';
    successDiv.textContent = message;
    document.body.appendChild(successDiv);
    setTimeout(() => {
        successDiv.style.animation = 'slideUp 0.3s ease';
        setTimeout(() => successDiv.remove(), 300);
    }, 3000);
}

async function handleLogout() {
    try {
        await signOut(auth);
        localStorage.clear();
        window.location.href = 'index.html';
    } catch (error) {
        console.error('Logout error:', error);
        alert('Failed to logout. Please try again.');
    }
}

window.handleLogout = handleLogout;;</script>

</body>