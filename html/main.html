<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Issue Reporting System</title>
    <link rel="stylesheet" href="/OJT-/css/styles.css">
   </head>

<body>

<div class="user-info" id="userInfo" style="display: none;">
    <span class="user-email" id="userEmail"></span>
    <button class="logout-btn" onclick="handleLogout()">Logout</button>
</div>

<button class="hamburger-btn" id="hamburgerBtn">
    <span></span><span></span><span></span>
</button>
<div class="overlay" id="overlay"></div>

<div class="sidebar" id="sidebar">
    <h2>Recent Issues</h2>
    <div id="issuesList"></div>
</div>

<div class="main-container">
    <div class="form-container">
        <h1>Report an Issue</h1>
        <p>Help us improve by reporting bugs or requesting features</p>

        <form id="issueForm">
            <div class="form-group">
                <label>Issue Title *</label>
                <input type="text" id="title" required placeholder="Brief description">
            </div>

            <div class="form-group">
                <label>Your Email *</label>
                <input type="email" id="email" required placeholder="you@email.com" readonly>
            </div>

            <div class="form-group">
                <label>Priority *</label>
                <select id="priority" required>
                    <option value="">Select priority</option>
                    <option value="low">Low</option>
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                </select>
            </div>

            <div class="form-group">
                <label>Category *</label>
                <select id="category" required>
                    <option value="">Select category</option>
                    <option value="bug">Bug Report</option>
                    <option value="feature">Feature Request</option>
                </select>
            </div>

            <div class="form-group">
                <label>Description *</label>
                <textarea id="description" required></textarea>
            </div>

            <button type="submit" class="submit-btn">Submit Issue</button>
        </form>
    </div>
</div>
<!-- <script src="/OJT-/javascript/script.js"></script> -->

<script type="module">
// Import Firebase modules
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref, push, set, onValue, query, orderByChild } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// Firebase configuration
const firebaseConfig = {
    apiKey: "AIzaSyBeqThBgikkUrn_HytZHFUxPs19kJsFHXo",
    authDomain: "issuelogger-522de.firebaseapp.com",
    databaseURL: "https://issuelogger-522de-default-rtdb.asia-southeast1.firebasedatabase.app", //needed to change to asia cause of database nonsense wtf
    projectId: "issuelogger-522de",
    storageBucket: "issuelogger-522de.firebasestorage.app",
    messagingSenderId: "964094432254",
    appId: "1:964094432254:web:c51ccade6af6bef5a0a6af",
    measurementId: "G-H92P42RJFD"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const database = getDatabase(app);

let currentUser = null;

// Check authentication 
onAuthStateChanged(auth, (user) => {
    if (user) {
        currentUser = user;
        document.getElementById('userInfo').style.display = 'flex';
        document.getElementById('userEmail').textContent = user.email;
        document.getElementById('email').value = user.email;
        // Load user's issues
        loadUserIssues(user.uid);
    } else {
        window.location.href = 'index.html';
    }
});

// Hamburger menu 
const hamburgerBtn = document.getElementById("hamburgerBtn");
const overlay = document.getElementById("overlay");
const sidebar = document.getElementById("sidebar");

function toggleSidebar(){
    sidebar.classList.toggle("open");
    overlay.classList.toggle("active");
    hamburgerBtn.classList.toggle("active");
}

hamburgerBtn.addEventListener("click", toggleSidebar);
overlay.addEventListener("click", toggleSidebar);

// Load user's issues from Firebase
function loadUserIssues(userId) {
    const issuesRef = ref(database, `issues/${userId}`);
    const issuesQuery = query(issuesRef, orderByChild('timestamp'));
    
    onValue(issuesQuery, (snapshot) => {
        const issuesContainer = document.getElementById("issuesList");
        
        if (!snapshot.exists()) {
            issuesContainer.innerHTML = `<p class="empty-state">No issues reported yet</p>`;
            return;
        }
        
        const issues = [];
        snapshot.forEach((childSnapshot) => {
            const issue = childSnapshot.val();
            issue.id = childSnapshot.key;
            issues.push(issue);
        });
        
        // Reverse to show newest first
        issues.reverse();
        
        renderIssues(issues);
    });
}

// Render issues in sidebar
function renderIssues(issues){
    const container = document.getElementById("issuesList");
    
    if(issues.length === 0){
        container.innerHTML = `<p class="empty-state">No issues reported yet</p>`;
        return;
    }
    
    container.innerHTML = issues.map(issue => {
        const timeAgo = getTimeAgo(issue.timestamp);
        const priorityClass = issue.priority.toLowerCase();
        
        return `
            <div class="issue-card" data-id="${issue.id}">
                <div class="issue-title">${escapeHtml(issue.title)}</div>
                <div class="issue-meta">
                    <span class="priority-badge ${priorityClass}">${issue.priority}</span>
                    <span>•</span>
                    <span>${issue.category === 'bug' ? 'Bug' : 'Feature'}</span>
                    <span>•</span>
                    <span>${timeAgo}</span>
                </div>
            </div>
        `;
    }).join("");
}

// Handle submission (nice)
const issueForm = document.getElementById("issueForm");

issueForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    
    if (!currentUser) {
        alert("You must be logged in to submit an issue");
        return;
    }
    
    // Get form values
    const title = document.getElementById("title").value.trim();
    const email = document.getElementById("email").value.trim();
    const priority = document.getElementById("priority").value;
    const category = document.getElementById("category").value;
    const description = document.getElementById("description").value.trim();
    
    // Validate
    if (!title || !email || !priority || !category || !description) {
        alert("Please fill in all required fields");
        return;
    }
    
    // Create issue object
    const issue = {
        title: title,
        email: email,
        priority: priority,
        category: category,
        description: description,
        timestamp: Date.now(),
        status: "open",
        userId: currentUser.uid
    };
    
    try {
        // Save to Firebase
        const issuesRef = ref(database, `issues/${currentUser.uid}`);
        const newIssueRef = push(issuesRef);
        await set(newIssueRef, issue);
        
        // Show success message
        showSuccessMessage("Issue submitted successfully!");
        
        // Reset form
        issueForm.reset();
        document.getElementById("email").value = currentUser.email;
        
    } catch (error) {
        console.error("Error submitting issue:", error);
        alert("Failed to submit issue. Please try again.");
    }
});


function getTimeAgo(timestamp) {
    const now = Date.now();
    const diff = now - timestamp;
    
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (minutes < 1) return "Just now";
    if (minutes < 60) return `${minutes}m ago`;
    if (hours < 24) return `${hours}h ago`;
    if (days < 7) return `${days}d ago`;
    
    const date = new Date(timestamp);
    return date.toLocaleDateString();
}

// Utility function to escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Show success message
function showSuccessMessage(message) {
    const successDiv = document.createElement('div');
    successDiv.className = 'success-toast';
    successDiv.textContent = message;
    successDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #10b981;
        color: white;
        padding: 16px 24px;
        border-radius: 8px;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        animation: slideIn 0.3s ease;
    `;
    
    document.body.appendChild(successDiv);
    
    setTimeout(() => {
        successDiv.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => successDiv.remove(), 300);
    }, 3000);
}

// Handle logout
async function handleLogout() {
    try {
        await signOut(auth);
        localStorage.clear();
        window.location.href = 'index.html';
    } catch (error) {
        console.error('Logout error:', error);
        alert('Failed to logout. Please try again.');
    }
}

window.handleLogout = handleLogout;

// Add styles
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from {
            transform: translateX(400px);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes slideOut {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(400px);
            opacity: 0;
        }
    }
    
    .priority-badge {
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
    }
    
    .priority-badge.high {
        background: #fee2e2;
        color: #dc2626;
    }
    
    .priority-badge.medium {
        background: #fef3c7;
        color: #d97706;
    }
    
    .priority-badge.low {
        background: #dbeafe;
        color: #2563eb;
    }
`;
document.head.appendChild(style);
</script>

</body>
</html>